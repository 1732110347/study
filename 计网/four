4.1.1 网络层提供的两种服务
争论：
网络层应该向运输层提供怎样的服务？面向连接还是无连接？
在计算机通信中，可靠交付应当由谁来负责？是网络还是端系统？
2 种观点：
面向连接的可靠交付。
无连接的、尽最大努力交付的数据报服务，不提供服务质量的承诺。

一种观点：让网络负责可靠交付
计算机网络模仿电信网络，使用面向连接的通信方式。
通信之前先建立虚电路 VC (Virtual Circuit) (即连接)，以保证双方通信所需的一切网络资源。 
如果再使用可靠传输的网络协议，可使所发送的分组无差错按序到达终点，不丢失、不重复。

虚电路只是一条逻辑上的连接，分组都沿着这条逻辑连接按照存储转发方式传送，并不是真正建立了一条物理连接。

另一种观点：网络提供数据报服务
互联网采用的设计思路：
网络层要设计得尽量简单，向其上层只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。
网络在发送分组时不需要先建立连接。
每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。
网络层不提供服务质量的承诺。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），也不保证分组传送的时限。
由主机中的运输层负责可靠的通信。


虚电路服务与数据报服务的对比
对比的方面	虚电路服务	数据报服务
思路	可靠通信应当由网络来保证	可靠通信应当由用户主机来保证
连接的建立	必须有	不需要
终点地址	仅在连接建立阶段使用，每个分组使用短的虚电路号	每个分组都有终点的完整地址
分组的转发	属于同一条虚电路的分组均按照同一路由进行转发	每个分组独立选择路由进行转发
当结点出故障时	所有通过出故障的结点的虚电路均不能工作	出故障的结点可能会丢失分组，一些路由可能会发生变化
分组的顺序	总是按发送顺序到达终点	到达终点时不一定按发送顺序
端到端的差错处理和流量控制	可以由网络负责，也可以由用户主机负责	由用户主机负责


4.1.2 网络层的两个层面
不同网络中的两个主机之间的通信，要经过若干个路由器转发分组来完成。
在路由器之间传送的信息有以下 2 大类：
数据。
路由信息（为数据传送服务）。

数据层面和控制层面
数据层面
路由器根据本路由器生成的转发表，把收到的分组从查找到的对应接口转发出去。
独立工作。
采用硬件进行转发，快。

控制层面
根据路由选择协议所用的路由算法计算路由，创建出本路由器的路由表。
许多路由器协同动作。
采用软件计算，慢。

远程控制器：
计算出最佳的路由，
在每一个路由器中生成其正确的转发表。

路由器：
查找转发表，转发分组。


4.2  网际协议 IP 
与网际协议 IPv4 配套的 3 个协议：
地址解析协议 ARP (Address Resolution Protocol)
网际控制报文协议 ICMP (Internet Control Message Protocol)
网际组管理协议 IGMP (Internet Group Management Protocol)


4.2.1  虚拟互连网络

实现异构网络的互连互通方法，哪种好？
使用中间设备
可以满足不同需求
实用

层              中间设备
运输层及以上     网关(gateway)
网络层           路由器 (router)
数据链路层       网桥或桥接器 (bridge)，交换机 (switch)
物理层           转发器 (repeater)


使用转发器或网桥不称为网络互连
转发器、网桥或交换机仅把一个网络扩大了，仍然是一个网络

网络互连使用路由器

IP 网的意义
当互联网上的主机进行通信时，就好像在一个网络上通信一样，看不见互连的各具体的网络异构细节。
如果在这种覆盖全球的 IP 网的上层使用 TCP 协议，那么就是现在的互联网 (Internet)。

4.2.2  IP 地址
在 TCP/IP 体系中，IP 地址是一个最基本的概念。
没有IP地址，就无法和网上的其他设备进行通信。
本部分重点：
IP 地址及其表示方法
分类的 IP 地址
无分类编址 CIDR
IP 地址的特点


1. IP 地址及其表示方法

IP 地址：32 位二进制代码

分为每 8 位为一组
用点分十进制记法
互联网上的每台主机（或路由器）的每个接口分配一个在全世界唯一的 IP 地址。
由互联网名字和数字分配机构 ICANN (Internet Corporation for Assigned Names and Numbers) 进行分配。 


IP 地址采用 2 级结构
2 级结构
2 个字段：网络号和主机号 IP 地址 ::= { <网络号>, <主机号>} 
IP地址在整个互联网范围内是唯一的。
IP 地址指明了连接到某个网络上的一个主机


2. 分类的 IP 地址
A 类地址 0 8 24   占50
B 类地址 10 16 16  占25
C 类地址 110 24 8   占12.5
单播地址

D类地址 1110 多播地址
E类地址 1111 保留为今后使用

各类 IP 地址的指派范围
网络
类别	最大可指派的网络数	第一个可指派的网络号	最后一个可指派的网络号	每个网络中最大主机数
A	126 (2^7 – 2)	              1	              126	              16777214
B	16383 (2^14 – 1)	       128.1	              191.255	       65534
C	2097151 (2^21 – 1)	       192.0.1	       223.255.255	       254
注意：指派时要扣除全 0 和全 1 的主机号


一般不使用的特殊的 IP 地址
网络号	主机号	源地址使用	目的地址使用	代表的意思
0	0	可以	不可	在本网络上的本主机（见 6.6 节 DHCP 协议）
0	X	可以	不可	在本网络上主机号为 X 的主机
全 1	全 1	不可	可以	只在本网络上进行广播（各路由器均不转发）
Y	全 1	不可	可以	对网络号为 Y 的网络上的所有主机进行广播
127	非全 0 或全 1 的任何数	可以	可以	用于本地软件环回测试

全0表示地址是网络地址，不能分配给网络中的主机或路由器接口
全1是广播地址，不能分配给网络中的主机或路由器接口

A类最小网络号是0，保留不指派
第一个可指派的网络号为1 网络地址为1.0.0.0
最大网络号为127，作为本地环回测试地址，不值派
最小的本地环回测试地址为127.0.0.1
最大的本地环回测试地址为127.255.255.254
最后一个可指派的网络号126，网络地址为126.0.0.0

B类最小网络号也是第一个可指派的网络号128.0 网络地址为128.0.0.0
最大网络号也是最后一个可指派的网络号191.255 网络地址为191.255.0.0

C类最小网络号也是第一个可指派的网络号192.0.0
网络地址为192.0.0.0
最大网络号也是最后一个可指派的网络号223.255.255
网络地址为223.250.255.0


分类的 IP 地址的优点和缺点
管理简单；
使用方便；
转发分组迅速；
划分子网，灵活地使用。

设计上不合理：
大地址块，浪费地址资源；
即使采用划分子网的方法，也无法解决 IP 地址枯竭的问题。


3. 无分类编址 CIDR
CIDR (Classless Inter-Domain Routing) ：无分类域间路由选择。
消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，可以更加有效地分配 IPv4 的地址空间，但无法解决 IP 地址枯竭的问题。
要点：
(1) 网络前缀
(2) 地址块
(3) 地址掩码

(1) 网络前缀
2 级结构    IP 地址 ::= { <网络前缀>, <主机号>} 
2 个字段：网络前缀和主机号
最大的区别：
前缀的位数 n 不固定，可以在 0 ~ 32 之间选取任意值。

CIDR 记法：斜线记法 (slash notation)
a.b.c.d / n：二进制 IP 地址的前 n 位是网络前缀。
例如：128.14.35.7/20：前 20 位是网络前缀。

(2) 地址块
CIDR 把网络前缀都相同的所有连续的 IP 地址组成一个 CIDR 地址块。
一个 CIDR 地址块包含的 IP 地址数目，取决于网络前缀的位数


(3) 地址掩码 (address mask)
又称为子网掩码 (subnet mask)。
位数：32 位。
目的：让机器从 IP 地址迅速算出网络地址。
由一连串 1 和接着的一连串 0 组成，而 1 的个数就是网络前缀的长度。
/20 地址块的地址掩码：11111111 11111111 11110000 00000000
点分十进制记法：255.255.240.0
       CIDR 记法：255.255.240.0/20。

默认地址掩码            网络号                      主机号
A类地址 255.0.0.0    1111111100000000 00000000 00000000
B 255.255.0.0       111111111111111100000000 00000000
C 255.255.255.0     111111111111111111111111 00000000

网络地址 = (二进制的 IP 地址) AND (地址掩码)

IP地址      网络前缀            主机号
            逐位进行AND运算
地址掩码    1111111111111111    000000000000000

网络地址    网络前缀            000000000000000


三个特殊的 CIDR 地址块

网络前缀长度	点分十进制	说明
/32	255.255.255.255	就是一个 IP 地址。这个特殊地址用于主机路由
/31	255.255.255.254	只有两个 IP 地址，其主机号分别为 0 和 1。
这个地址块用于点对点链路
/0	0.0.0.0	同时 IP 地址也是全 0，即 0.0.0.0/0。用于默认路由。


路由聚合 (route aggregation)
聚合为 1 个 地址，
地址掩码=255.255.240.0，
路由表中只需 1 个路由项目。


4. IP 地址的特点



4.2.3  IP 地址与 MAC 地址
IP 地址
虚拟地址、软件地址、逻辑地址。
网络层和以上各层使用。
放在 IP 数据报的首部。


MAC 地址
固化在网卡上的 ROM 中。
硬件地址、物理地址。
数据链路层使用。
放在 MAC 帧的首部。


4.2.4  地址解析协议 ARP
实现 IP 通信时使用了两个地址：
IP 地址（网络层地址）
MAC 地址（数据链路层地址）

要点 1：ARP 高速缓存 (ARP cache)
ARP 高速缓存 (ARP cache)：
存放 IP 地址到 MAC 地址的映射表。
映射表动态更新（新增或超时删除）。

映射表
< IP 地址；MAC 地址；生存时间 (Age)；类型等 >

超过生存时间的项目都从高速缓存中删除，以适应网络适配器变化。

要点 2：ARP 工作
当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时：


要点 3：ARP 查找 IP 地址对应的 MAC地址
本局域网上广播发送 ARP 请求（路由器不转发 ARP 请求）。
ARP 请求分组：包含发送方硬件地址 / 发送方 IP 地址 / 目标方硬件地址(未知时填 0) / 目标方 IP 地址。
单播 ARP 响应分组：包含发送方硬件地址 / 发送方 IP地址 / 目标方硬件地址 / 目标方 IP 地址。
ARP 分组封装在以太网帧中传输。

ARP 高速缓存的作用
存放最近获得的 IP 地址到 MAC 地址的绑定。
减少 ARP 广播的通信量。
为进一步减少 ARP 通信量，主机 A 在发送其 ARP 请求分组时，就将自己的 IP 地址到 MAC 地址的映射写入 ARP 请求分组。
当主机 B 收到 A 的 ARP 请求分组时，就将主机 A 的 IP 地址及其对应的 MAC 地址映射写入主机 B 自己的 ARP 高速缓存中。不必在发送 ARP 请求。

ARP 用于解决同一个局域网上的主机或路由器的 IP 地址和 MAC 地址的映射问题。
通信的路径：A → 经过 R1 转发 → B。
因此主机 A 必须知道路由器 R1 的 IP 地址，解析出其 MAC 地址。然后把 IP 数据报传送到路由器 R1。


4.2.5  IP 数据报的格式
首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。

1.  IP 数据报首部的固定部分中的各字段
总长度——占 16 位，指首部和数据之和的长度，
单位为字节，因此数据报的最大长度为 65535 字节。
总长度必须不超过最大传送单元 MTU。 



4.3.1  基于终点的转发
分组在互联网中是逐跳转发的。
基于终点的转发：基于分组首部中的目的地址传送和转发。

为了压缩转发表的大小，
转发表中最主要的路由是（目的网络地址，下一跳地址） ，
而不是（目的地址，下一跳地址）。
查找转发表的过程就是逐行寻找前缀匹配。


4.3.2  最长前缀匹配
使用 CIDR 时，在查找转发表时可能会得到不止一个匹配结果。 
最长前缀匹配 (longest-prefix matching) 原则：选择前缀最长的一个作为匹配的前缀。
网络前缀越长，其地址块就越小，因而路由就越具体。
把前缀最长的排在转发表的第 1 行。

转发表中的 2 种特殊的路由
主机路由 (host route) 
又叫做特定主机路由。
是对特定目的主机的 IP 地址专门指明的一个路由。
网络前缀就是 a.b.c.d/32
放在转发表的最前面。
默认路由 (default route)
不管分组的最终目的网络在哪里，都由指定的路由器 R 来处理
用特殊前缀 0.0.0.0/0 表示。


4.4  网际控制报文协议 ICMP 
ICMP (Internet Control Message Protocol) 允许主机或路由器报告差错情况和提供有关异常情况的报告。
ICMP 是互联网的标准协议。
但 ICMP 不是高层协议，而是 IP 层的协议。


不应发送 ICMP 差错报告报文的几种情况
对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。
对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。
对具有多播地址的数据报都不发送 ICMP 差错报告报文。
对具有特殊地址（如127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。

ICMP 询问报文
(1) 回送请求和回答
由主机或路由器向一个特定的目的主机发出的询问。
收到此报文的主机必须给源主机或路由器发送 ICMP 回送回答报文。
这种询问报文用来测试目的站是否可达，以及了解其有关状态。
(2) 时间戳请求和回答：
请某台主机或路由器回答当前的日期和时间。
时间戳回答报文中有一个 32 位的字段，其中写入的整数代表从1900 年 1 月 1 日起到当前时刻一共有多少秒。
时间戳请求与回答可用于时钟同步和时间测量。


4.4.2  ICMP 的应用举例
PING (Packet InterNet Groper) 
用来测试两个主机之间的连通性。
使用了 ICMP 回送请求与回送回答报文。
是应用层直接使用网络层 ICMP 的例子，没有通过运输层的 TCP 或 UDP。 

Traceroute
这是UNIX操作系统中名字。在 Windows 操作系统中这个命令是 tracert。
用来跟踪一个分组从源点到终点的路径。
它利用 IP 数据报中的 TTL 字段、ICMP 时间超过差错报告报文和ICMP 终点不可达差错报告报文实现对从源点到终点的路径的跟踪。


4.5.1  IPv6 的基本首部
IPv6 仍支持无连接的传送。
将协议数据单元 PDU 称为分组 (packet) 。
主要变化（1/2）：
更大的地址空间。 将地址从 IPv4 的 32 位 增大到了 128 位。 
扩展的地址层次结构。可以划分为更多的层次。 
灵活的首部格式。定义了许多可选的扩展首部。
改进的选项。允许数据报包含有选项的控制信息，其选项放在有效载荷中。
允许协议继续扩充。更好地适应新的应用。
支持即插即用（即自动配置）。不需要使用 DHCP。
支持资源的预分配。支持实时视像等要求保证一定的带宽和时延的应用。
IPv6 首部改为 8 字节对齐。首部长度必须是 8 字节的整数倍。

IPv6 数据报的一般形式
由两大部分组成：
基本首部 (base header)
有效载荷 (payload)。有效载荷也称为净负荷。有效载荷允许有零个或多个扩展首部 (extension header)，再后面是数据部分。

首部长度：固定的 40 字节，称为基本首部。
首部字段数：只有 8 个。

取消了首部长度字段；
取消了服务类型字段；
取消了总长度字段，改用有效载荷长度字段；

把 TTL 字段改称为跳数限制字段；
取消了协议字段，改用下一个首部字段；
取消了检验和字段；
取消了选项字段，而用扩展首部来实现选项功能。

跳数限制(hop limit)—— 8 位。源站在数据报发出时即设定跳数限制。路由器在转发数据报时将跳数限制字段中的值减 1。当跳数限制的值为零时，就要将此数据报丢弃。 


源地址—— 128 位。是数据报的发送站的 IP 地址。
的地址—— 128 位。是数据报的接收站的 IP 地址。


IPv6 的六种扩展首部
逐跳选项
路由选择
分片
鉴别
封装安全有效载荷
目的站选项


4.5.2  IPv6 的地址
三种基本类型：
单播 (unicast)：传统的点对点通信。
多播 (multicast)：一点对多点的通信。
任播 (anycast)：IPv6 增加的一种类型。任播的终点是一组计算机，但数据报在交付时只交付其中的一个。通常是按照路由算法得出的距离最近的一个。 

节点与接口
IPv6 将实现 IPv6 的主机和路由器均称为节点。
一个节点可能有多个与链路相连的接口。
IPv6 地址是分配给节点上接口的。
一个具有多个接口的节点可以有多个单播地址。
其中的任何一个地址都可以当作到达该节点的目的地址。

冒号十六进制记法
在 IPv6 中，每个地址占 128 位，地址空间大于 3.4  1038 。
使用冒号十六进制记法(colon hexadecimal notation, 简写为 colon hex)：16 位的值用十六进制值表示，各值之间用冒号分隔。

零压缩 (zero compression)：一串连续的零可以用一对冒号取代。


地址类型	二进制前缀	IPv6记法
未指明地址	00…0（128位），仅此一个	::/128
环回地址	00…1（128位），仅此一个	::1/128
多播地址	11111111（8位），功能和 IPv4 的一样	FF00::/8
本地链路单播地址	1111111010（10位）, 未连接到互联网，不能和互联网上的其他主机通信	FE80::/10
全球单播地址	除上述四种外，所有其他的二进制前缀


4.5.3  从 IPv4 向 IPv6 过渡
方法：逐步演进，向后兼容。
向后兼容：IPv6 系统必须能够接收和转发 IPv4 分组，并且能够为 IPv4 分组选择路由。
两种过渡策略：
使用双协议栈
使用隧道技术

4.5.4  ICMPv6

IPv6 也需要使用 ICMP 来反馈一些差错信息。新的版本称为 ICMPv6。

ND (Neighbor-Discovery)：邻站发现
MLD (Multicast Listener Delivery)：多播听众交付


4.6.1  有关路由选择协议的几个基本概念
路由选择协议属于网络层控制层面的内容

路由选择非常复杂
需要所有节点共同协调工作的。
环境不断变化，而这种变化有时无法事先知道。
当网络发生拥塞时，很难获得所需的路由选择信息。


路由算法分类（自适应）
静态路由选择策略
非自适应路由选择；
不能及时适应网络状态的变化；
简单，开销较小。 

动态路由选择策略
自适应路由选择；
能较好地适应网络状态的变化；
实现较为复杂，开销较大。


2. 分层次的路由选择协议
互联网：
采用自适应的（即动态的）、分布式路由选择协议。
把整个互联网划分为许多较小的自治系统 AS，采用分层次的路由选择协议。
分为 2 个层次：
自治系统之间的路由选择 或 域间路由选择 (interdomain routing)；
自治系统内部的路由选择 或 域内路由选择 (intradomain routing)；


自治系统 AS ：
是在单一技术管理下的许多网络、IP地址以及路由器，而这些路由器使用一种自治系统内部的路由选择协议和共同的度量。每一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略。


2 大类路由选择协议
内部网关协议 IGP 
Interior Gateway Protocol
在一个自治系统内部使用的路由选择协议
常用：RIP，OSPF

外部网关协议 EGP 
External Gateway Protocol
在不同自治系统之间进行路由选择时使用的协议
使用最多：BGP-4

4.6.2  内部网关协议 RIP

                     互联网路由选择协议
       域内路由选择                域间路由选择
距离向量         链路状态          路径向量
(path vector)    (Link State)  (Distance Vector)
RIP                  OSPF          BGP-4


1. 协议 RIP 的工作原理
路由信息协议 RIP (Routing Information Protocol) 是一种分布式的、基于距离向量的路由选择协议。
互联网的标准协议。
最大优点：简单。
要求网络中的每个路由器都要维护从它自己到其他每一个目的网络的距离记录。 

路由器到直接连接的网络的距离 = 1。
路由器到非直接连接的网络的距离 = 所经过的路由器数 + 1。
RIP 协议中的“距离”也称为“跳数”(hop count)，每经过一个路由器，跳数就加 1。

好路由 = “距离短”的路由。最佳路由 = “距离最短”的路由。
一条路径最多只能包含 15 个路由器。
“距离”的最大值为 16 时即相当于不可达。
RIP 不能在两个网络之间同时使用多条路由，只选择距离最短”的路由。

RIP 协议的三个特点
仅和相邻路由器交换信息。 
交换的信息是当前本路由器所知道的全部信息，即自己的路由表。 
按固定时间间隔交换路由信息，例如，每隔 30 秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息。

路由表的建立
路由器在刚刚开始工作时，路由表是空的。
然后，得到直接连接的网络的距离（此距离定义为 1）。
之后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。
经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。
RIP 协议的收敛 (convergence) 过程较快。“收敛”就是在自治系统中所有的结点都得到正确的路由选择信息的过程。 


2. 距离向量算法
(1) 修改 RIP 报文中的所有项目（即路由）：把“下一跳”字段中的地址都改为 X，并把所有的“距离”字段的值加 1。
(2) 对修改后的 RIP 报文中的每一个项目，重复以下步骤：
    若路由表中没有目的网络N，则把该项目添加到路由表中。否则
        若路由表中网络 N 的下一跳路由器为 X，则用收到的项目替换原路由表中的项目。否则
           若收到项目中的距离小于路由表中的距离，则用收到项目更新原路由表中的项目。否则
               什么也不做。
(3) 若 3 分钟还未收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为 16（表示不可达）。
(4) 返回。


RIP2 报文
组成：首部和路由 2 个部分。
路由部分：由若干个路由信息组成。每个路由信息共 20 个字节。
地址族标识符（又称为地址类别）字段用来标志所使用的地址协议。
路由标记填入自治系统的号码。
后面为具体路由，指出某个网络地址、该网络的子网掩码、下一跳路由器地址以及到此网络的距离。 
一个 RIP 报文最多可包括 25 个路由，因而 RIP 报文的最大长度是 4+20 x25=504 字节。如超过，必须再用一个 RIP 报文来传送。
RIP2 具有简单的鉴别功能。


3. 坏消息传播得慢
RIP 协议特点：好消息传播得快，坏消息传播得慢。
问题：坏消息传播得慢（慢收敛）。
当网络出现故障时，要经过比较长的时间才能将此信息（坏消息）传送到所有的路由器。


优点：
实现简单，开销较小。
缺点：
网络规模有限。最大距离为 15（16 表示不可达）。
交换的路由信息为完整路由表，开销较大。 
坏消息传播得慢，收敛时间过长。


4.6.3  内部网关协议 OSPF

开放最短路径优先 OSPF (Open Shortest Path First)是为克服 RIP 的缺点在 1989 年开发出来的。
原理很简单，但实现很复杂。
使用了 Dijkstra 提出的最短路径算法 SPF。
采用分布式的链路状态协议 (link state protocol)。 
现在使用 OSPFv2。

三个主要特点
采用洪泛法 (flooding)，向本自治系统中所有路由器发送信息。
发送的信息是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。
链路状态：说明本路由器都和哪些路由器相邻，以及该链路的度量 (metric)。 
当链路状态发生变化或每隔一段时间（如30分钟），路由器才用洪泛法向所有路由器发送此信息。


链路状态数据库 (link-state database) 
每个路由器最终都能建立。
全网的拓扑结构图。
在全网范围内是一致的（这称为链路状态数据库的同步）。
每个路由器使用链路状态数据库中的数据构造自己的路由表（例如，使用Dijkstra的最短路径路由算法）。
链路状态数据库能较快地进行更新，使各个路由器能及时更新其路由表。
重要优点：OSPF 更新过程收敛速度快。

OSPF 将自治系统划分为两种不同的区域 (area)
主干区域 (backbone area) 标识符= 0.0.0.0，作用=用来连通其他下层区域。 

OSPF 中的路由器：区域边界路由器 ABR (area border router)
OSPF 中的路由器：主干路由器 BR (backbone router)
OSPF 中的路由器：自治系统边界路由器 ASBR (AS border router)

优点：
减少了整个网络上的通信量。
减少了需要维护的状态数量。
缺点：
交换信息的种类增多了。
使 OSPF 协议更加复杂了。

分层次划分区域的好处：
使每一个区域内部交换路由信息的通信量大大减小，因而使 OSPF 协议能够用于规模很大的自治系统中

其他特点
对于不同类型的业务可计算出不同的路由。
可实现多路径间的负载均衡（load balancing）。
所有在 OSPF 路由器之间交换的分组都具有鉴别的功能。
支持可变长度的子网划分和无分类编址 CIDR。
32 位的序号，序号越大状态就越新。全部序号空间在 600 年内不会产生重复号。

2. OSPF 的五种分组类型
问候 (Hello) 分组。
数据库描述 (Database Description) 分组。
链路状态请求 (Link State Request) 分组。
链路状态更新 (Link State Update) 分组。
链路状态确认 (Link State Acknowledgment)分组。

1，确定邻站可达。
相邻路由器每隔 10 秒钟要交换一次问候分组。
若有 40 秒钟没有收到某个相邻路由器发来的问候分组，则可认为该相邻路由器是不可达的。
2，同步链路状态数据库。
同步：指不同路由器的链路状态数据库的内容是一样的。
两个同步的路由器叫做完全邻接的 (fully adjacent) 路由器。
3，更新链路状态。
只要链路状态发生变化，路由器就使用链路状态更新分组，采用可靠的洪泛法向全网更新链路状态。
为确保链路状态数据库与全网的状态保持一致，OSPF 还规定：每隔一段时间，如 30 分钟，要刷新一次数据库中的链路状态。

OSPF 链路状态只涉及相邻路由器，与整个互联网的规模并无直接关系，因此当互联网规模很大时，OSPF 协议要比距离向量协议 RIP 好得多。
OSPF 没有“坏消息传播得慢”的问题，收敛数度快。


指定的路由器 DR 
多点接入的局域网采用了指定的路由器 DR (designated router) 的方法，使广播的信息量大大减少。
指定的路由器代表该局域网上所有的链路向连接到该网络上的各路由器发送状态信息。 


4.6.4  外部网关协议 BGP
BGP 是不同自治系统的路由器之间交换路由信息的协议。 

1. 协议 BGP 的主要特点
用于自治系统 AS 之间的路由选择。
只能是力求选择出一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要计算出一条最佳路由。
互联网的规模太大，使得自治系统AS之间路由选择非常困难。
自治系统AS之间的路由选择必须考虑有关策略。
采用了路径向量 (path vector) 路由选择协议。


在 AS 之间， BGP 发言者在半永久性 TCP 连接（端口号为179）上建立 BGP 会话(session)。这种连接又称为 eBGP 连接。
在 AS 内部，任何相互通信的两个路由器之间必须有一个逻辑连接（也使用 TCP 连接）。AS 内部所有的路由器之间的通信是全连通的。这种连接常称为 iBGP 连接。
eBGP (external BGP) 连接：运行 eBGP 协议，在不同 AS 之间交换路由信息。
iBGP (internal BGP) 连接：运行 iBGP 协议， 在 AS 内部的路由器之间交换 BGP 路由信息

同一个协议 BGP（使用的报文类型、使用的属性、使用的状态机等都完全一样）。
但它们在通报前缀时采用的规则不同：
在 eBGP 连接的对等端得知的前缀信息，可以通报给一个 iBGP 连接的对等端。反过来也是可以的。
但从 iBGP 连接的对等端得知的前缀信息，则不能够通报给另一个 iBGP 连接的对等端。

BGP 路由 = [ 前缀, BGP属性 ] = [ 前缀, AS-PATH, NEXT-HOP ]
前缀：指明到哪一个子网（用 CIDR 记法表示）。
BGP 属性：最重要的两个属性是
自治系统路径 AS-PATH 
下一跳 NEXT-HOP。

3. 三种不同的自治系统 AS
末梢 AS：不会把来自其他 AS 的分组再转发到另一个 AS。必须向所连接的 AS 付费。
多归属 AS (multihomed AS)：同时连接到两个或两个以上的 AS。增加连接的可靠性。
穿越 AS：为其他 AS 有偿转发分组。
对等 AS：经过事先协商的两个 AS，彼此之间的发送或接收分组都不收费。


请记住：在属性 AS-PATH 中，不允许出现相同的 AS 号。


4. BGP 的路由选择
本地偏好 (local preference) 值最高的路由 （默认值=100）
AS 跳数最小的路由
使用热土豆路由选择算法（分组在 AS 内的转发次数最少）
路由器 BGP ID 数值最小的路由。具有多个接口的路由器有多个 IP 地址，BGP ID 就使用该路由器的 IP 地址中数值最大的一个。


5.  BGP-4 的四种报文
OPEN (打开)   用来与相邻的另一个 BGP 发言者建立关系，使通信初始化。
UPDATE (更新)        用来通告某一路由的信息，以及列出要撤销的多条路由。
KEEPALIVE (保活)     用来周期性地证实邻站的连通性。
NOTIFICATION (通知)  用来发送检测到的差错。


4.6.5  路由器的构成
路由器工作在网络层，用于互连网络。
是互联网中的关键设备。
路由器的主要工作：转发分组。
把从某个输入端口收到的分组，按照分组要去的目的地（即目的网络），把该分组从路由器的某个合适的输出端口转发给下一跳路由器

转发
根据转发表将用户的 IP 数据报从合适的端口转发出去。
仅涉及到一个路由器。
转发表是从路由表得出的。
转发表必须包含完成转发功能所必需的信息，每一行必须包含从要到达的目的网络到输出端口和某些 MAC 地址信息（如下一跳的以太网地址）的映射。

路由选择
按照路由选择算法，根据网络拓扑的变化情况，动态地改变所选择的路由，并由此构造出整个的路由表。
涉及到很多路由器。
路由表一般仅包含从目的网络到下一跳（用 IP 地址表示）的映射


若收到的分组是交换路由信息的分组，送交路由选择处理机。
若收到的是数据分组，按目的地址查找转发表，根据得出的结果，经交换结构到达合适的输出端口。若某分组正在查找转发表，该分组排队等待


2. 交换结构
常用交换方法有三种：通过存储器、通过总线、通过纵横交换结构

(1) 当路由器的某个输入端口收到一个分组时，就用中断方式通知路由选择处理机。然后分组就从输入端口复制到存储器中。
(2) 路由器处理机从分组首部提取目的地址，查找路由表，再将分组复制到合适的输出端口的缓存中。
(3) 若存储器的带宽（读或写）为每秒 M 个分组，那么路由器的交换速率（即分组从输入端口传送到输出端口的速率）一定小于 M/2。

(1) 数据报从输入端口通过共享的总线直接传送到合适的输出端口，而不需要路由选择处理机的干预。
(2) 当分组到达输入端口时若发现总线忙，则被阻塞而不能通过交换结构，并在输入端口排队等待。 
(3)因为每一个要转发的分组都要通过这一条总线，因此路由器的转发带宽就受总线速率的限制。

常被称为互连网络 (interconnection network)。
(1) 它有 2N 条总线，控制交叉节点可以使 N 个输入端口和 N 个输出端口相连接。
(2) 当输入端口收到一个分组时，就将它发送到水平总线上。
(3) 若通向输出端口的垂直总线空闲，则将垂直总线与水平总线接通，把该分组转发到这个输出端口。若输出端口已被占用，分组在输入端口排队等待。
特点：是一种无阻塞的交换结构，分组可以转发到任何一个输出端口，只要这个输出端口没有被别的分组占用。



4.7.1  IP 多播的基本概念
多播 (multicast)：以前曾译为组播。
目的：更好地支持一对多通信。
一对多通信：一个源点发送到许多个终点。

在互联网上进行多播就叫做 IP 多播。
互联网范围的多播要靠路由器来实现。
能够运行多播协议的路由器称为多播路由器 (multicast router)。
多播路由器也可以转发普通的单播 IP 数据报。
从 1992 年起，在互联网上开始试验虚拟的多播主干网 MBONE (Multicast Backbone On the InterNEt)。 

多播 IP 地址
在 IP 多播数据报的目的地址需要写入多播组的标识符。
多播组的标识符就是 IP 地址中的 D 类地址（多播地址）。
	地址范围：224.0.0.0 ~ 239.255.255.255
每一个 D 类地址标志一个多播组。
多播地址只能用于目的地址，不能用于源地址。

多播数据报
多播数据报和一般的 IP 数据报的区别：
目的地址：使用 D 类 IP 地址。
协议字段 = 2，表明使用网际组管理协议 IGMP。
尽最大努力交付，不保证一定能够交付多播组内的所有成员。
对多播数据报不产生 ICMP 差错报文。在 PING 命令后面键入多播地址，将永远不会收到响应。


4.7.2  在局域网上进行硬件多播
IANA 拥有的以太网地址块的高 24 位为 00-00-5E。
TCP/IP 协议使用的以太网地址块的范围是
	从   00-00-5E-00-00-00 
	到   00-00-5E-FF-FF-FF 
IANA 只拿出 01-00-5E-00-00-00 到 01-00-5E-7F-FF-FF （223 个地址）作为以太网多播地址。或者说，在 48 位的多播地址中，前 25 位都固定不变，只有后 23 位可用作多播。


4.7.3  网际组管理协议 IGMP 和多播路由选择协议
1.  IP 多播需要两种协议
网际组管理协议 IGMP (Internet Group Management Protocol)
使多播路由器知道多播组成员信息（有无成员）。
多播路由选择协议
使多播路由器协同工作，把多播数据报用最小代价传送给多播组的所有成员。

多播转发必须动态地适应多播组成员的变化（这时网络拓扑并未发生变化），因为每一台主机可以随时加入或离开一个多播组。
多播路由器在转发多播数据报时，不能仅仅根据多播数据报中的目的地址，还要考虑这个多播数据报从什么地方来和要到什么地方去。 
多播数据报可以由没有加入多播组的主机发出，也可以通过没有组成员的接入网络。 

2.  网际组管理协议 IGMP
IGMP 使用 IP 数据报传递其报文
在 IGMP 报文加上 IP 首部构成 IP 数据报。
但 IGMP 也向 IP 提供服务。
因此，不把 IGMP 看成是一个单独的协议，而是整个网际协议 IP 的一个组成部分。 
第一阶段：加入多播组。
第二阶段：探询组成员变化情况。


3.  多播路由选择
实际上就是要找出以源主机为根节点的多播转发树。
不同的多播组对应于不同的多播转发树。
同一个多播组，对不同的源点也会有不同的多播转发树。

M 个源，N 个多播组，需要 MⅹN 棵以源为根的多播转发树。

转发多播数据报时使用三种方法：
(1) 洪泛与剪除
(2) 隧道技术 (tunneling)
(3) 基于核心的发现技术

(1) 洪泛与剪除
适合于较小的多播组，所有组成员接入的局域网也是相邻接的。
开始时，路由器转发多播数据报使用洪泛的方法（这就是广播）。
为避免兜圈子，采用反向路径广播 RPB (Reverse Path Broadcasting) 的策略。

(3) 基于核心的发现技术 
对于多播组的大小在较大范围内变化时都适合。
对每一个多播组 G 指定一个核心 (core) 路由器，并给出它的 IP 单播地址。
核心路由器按照前面讲过的 2 种方法创建出对应于多播组 G 的转发树（核心路由器为根节点）。



几种多播路由选择协议
距离向量多播路由选择协议 DVMRP (Distance Vector Multicast Routing Protocol)。互联网上使用的第一个多播路由选择协议。
基于核心的转发树 CBT (Core Based Tree) 
开放最短通路优先的多播扩展 MOSPF (Multicast Extensions to OSPF) 
协议无关多播-稀疏方式 PIM-SM (Protocol Independent Multicast-Sparse Mode) 。唯一成为互联网标准的一个协议。
协议无关多播-密集方式 PIM-DM (Protocol Independent Multicast-Dense Mode) 


4.8.1  虚拟专用网 VPN
本地地址与全球地址
本地地址：仅在机构内部使用的 IP 地址，可以由本机构自行分配，而不需要向互联网的管理机构申请。
全球地址：全球唯一的 IP 地址，必须向互联网的管理机构申请。 
问题：如何区分本地地址和全球地址？
解决：RFC 1918 指明了一些专用地址 (private address)。
专用地址只能用作本地地址，而不能用作全球地址。
互联网中的所有路由器对目的地址是专用地址的数据报一律不进行转发。

三个专用 IP 地址块：
(1) 10.0.0.0/8
A类，从 10.0.0.0 到 10.255.255.255。1 个。

(2) 172.16.0.0/12
B类，从 172.16.0.0 到 172.31.255.255。连续 16 个。

(3) 192.168.0.0/16
C类，从 192.168.0.0 到 192.168.255.255。连续 256 个。


采用专用 IP 地址的互连网络称为专用互联网或本地互联网，或更简单些，就叫做专用网。
专用 IP 地址也叫做可重用地址 (reusable address)。

利用公用互联网作为本机构各专用网之间的通信载体，这样的专用网又称为虚拟专用网 VPN (Virtual Private Network)。
专用网：指这种网络是为本机构的主机用于机构内部的通信，而不是用于和网络外非本机构的主机通信。
虚拟：表示实际上没有使用通信专线，只是在效果上和真正的专用网一样。

如果专用网不同网点之间的通信必须经过公用的互联网，但又有保密的要求，那么所有通过互联网传送的数据都必须加密。
必须为每一个场所购买专门的硬件和软件，并进行配置，使每一个场所的 VPN 系统都知道其他场所的地址。

用隧道技术实现虚拟专用网

内联网 (intranet)：同一个机构的内部网络所构成的 VPN。
外联网 (extranet)：一个机构和某些外部机构共同建立的 。
远程接入 VPN (remote access VPN)：允许外部流动员工通过接入 VPN 建立 VPN 隧道访问公司内部网络，好像就是使用公司内部的本地网络访问一样。


4.8.2   网络地址转换 NAT
：在专用网上使用专用地址的主机如何与互联网上的主机通信（并不需要加密）
再申请一些全球 IP 地址。但这在很多情况下是不容易做到的。
采用网络地址转换 NAT。这是目前使用得最多的方法。

需要在专用网连接到互联网的路由器上安装 NAT 软件。
装有 NAT 软件的路由器叫做 NAT路由器，它至少有一个有效的外部全球 IP 地址。
所有使用本地地址的主机在和外界通信时，都要在 NAT 路由器上将其本地地址转换成全球 IP 地址，才能和互联网连接。

网络地址转换的过程
在内部主机与外部主机通信时，在 NAT 路由器上发生了两次地址转换：
离开专用网时：替换源地址，将内部地址替换为全球地址。
进入专用网时：替换目的地址，将全球地址替换为内部地址。






